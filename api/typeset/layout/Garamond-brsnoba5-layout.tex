% =============================================================================
% TITLE: Gabarits pour livre format BrochSnob5 avec police Garamond
% DESCRIPTION: Modèle de mise en page pour un livre format B5 (143.5mm x 210mm) 
%              utilisant la police Garamond Premier Pro
% VERSION: 1.0
% =============================================================================

% =============================================================================
% 1. CLASSE DE DOCUMENT ET PACKAGES ESSENTIELS
% =============================================================================

% Classe de document : memoir pour un livre avec format personnalisé
\documentclass[a5paper,9pt]{memoir}

% Packages de base pour la typographie et les langues
\usepackage{fontspec}           % Gestion des polices OpenType
\usepackage[provide=*,french]{babel}  % Support multilingue (français)
\usepackage{microtype}          % Amélioration de la typographie

% =============================================================================
% 2. CONFIGURATION DES POLICES
% =============================================================================

% Configuration de la police principale Garamond Premier Pro
\setmainfont{Garamond Premier Pro}[
    Path = /usr/local/share/fonts/custom/,
    Extension = .otf,
    UprightFont = GaramondPremrPro,
    BoldFont = GaramondPremrPro-Bd,
    ItalicFont = GaramondPremrPro-It,
    BoldItalicFont = GaramondPremrPro-BdIt
]

% Définition des commandes de police personnalisées
\newcommand{\headerfont}{\normalfont}
\newcommand{\titrefont}{\normalfont}

% =============================================================================
% 3. CONFIGURATION DE LA MISE EN PAGE
% =============================================================================

% Configuration des dimensions et marges du document
\usepackage[paperwidth=143.5mm, paperheight=210mm, margin=18mm, bottom=22mm, top=24mm, head=13.6pt,headsep=7pt, foot=13pt, footskip=14pt]{geometry}

% Configuration des en-têtes et pieds de page
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\fancyhead[LE]{\headerfont\rightmark}
\fancyhead[RO]{\headerfont\leftmark}
\fancyhead[RE,LO]{\thepage}
\fancyhead[RE,LO]{\headerfont\fontsize{10}{10}\selectfont\thepage}

% =============================================================================
% 4. CONFIGURATION DES SECTIONS ET TITRES
% =============================================================================

% Package pour la personnalisation des titres
\usepackage{titlesec}

% Redéfinition des sections : page vide avant chaque section (optionnelle)
\let\stdsection\section
\renewcommand{\section}[1]{%
  \ifSectionNewPage
    \clearpage
    \thispagestyle{empty} % pas de numéro ni header sur cette page
  \fi
  \stdsection{#1}%
}

% Configuration des styles de titres
\setsecheadstyle{\titrefont\large\centering}
\setsecnumdepth{none}
\settocdepth{subsubsection}

% Personnalisation du format des sections
\titleformat{\section}
  {\titrefont\large\centering\vspace*{2cm}}
  {\thesection}
  {1em}
  {}
  []

% Personnalisation du format des sous-sections
\titleformat{\subsection}
  {\titrefont\normalsize\bfseries}
  {\thesubsection}
  {1em}
  {}
  []

% Personnalisation du format des sous-sous-sections
\titleformat{\subsubsection}
  {\titrefont\normalsize\itshape}
  {\thesubsubsection}
  {1em}
  {}
  []

% Configuration des marques de section pour les en-têtes
\renewcommand{\sectionmark}[1]{\markboth{#1}{#1}}

% =============================================================================
% 5. CONFIGURATION DES IMAGES ET GRAPHIQUES
% =============================================================================

% Package pour la gestion des images
\usepackage{graphicx}

% Configuration des chemins d'images
\graphicspath{{./}{../images/}{../../images/}}
\DeclareGraphicsExtensions{.pdf,.png,.jpg,.jpeg}
\setkeys{Gin}{width=\linewidth, keepaspectratio}

% Configuration des flottants et figures
\usepackage{float}
\floatstyle{plain}
\newfloat{inlinefigure}{H}{lof}
\floatname{inlinefigure}{Figure}

% Redéfinition de includegraphics pour forcer les images dans des inlinefigure
\let\oldincludegraphics\includegraphics
\renewcommand{\includegraphics}[2][]{%
  \begin{inlinefigure}
    \centering
    \IfFileExists{#2}{%
      \oldincludegraphics[#1]{#2}%
    }{%
      \fbox{\parbox{0.8\linewidth}{\centering Image non trouvée : #2}}%
    }%
  \end{inlinefigure}%
}

% =============================================================================
% 6. PACKAGES UTILITAIRES ET FONCTIONNALITÉS
% =============================================================================

% Gestion des couleurs (pour tests typographiques)
\usepackage{xcolor}
% \usepackage{pagecolor} % Change the color to your desired shade of gray
% \pagecolor{lightgray}  % Change the color to your desired shade of gray

% Configuration des liens hypertexte
\usepackage{hyperref}
\usepackage{url}
\urlstyle{same}
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    urlcolor=black,
    citecolor=black,
    anchorcolor=black,
    pdfborder={0 0 0}
}

% Gestion des paragraphes encadrés
\usepackage{mdframed}
\newmdenv[
    linewidth=0.5pt,
    roundcorner=5pt,
    innerleftmargin=5pt,
    innerrightmargin=5pt,
    innertopmargin=5pt,
    innerbottommargin=5pt
]{framedparagraph}

% Gestion du texte long (séparation automatique)
\usepackage{seqsplit}

% Gestion des listes avec espacement personnalisé
\usepackage{enumitem}
\setlist[itemize]{topsep=2pt, partopsep=0pt, parsep=0pt, itemsep=2pt}
\setlist[enumerate]{topsep=2pt, partopsep=0pt, parsep=0pt, itemsep=2pt}

% Gestion des tableaux avec espacement
\usepackage{etoolbox}
\BeforeBeginEnvironment{tabular}{\medskip}
\AfterEndEnvironment{tabular}{\medskip}
\renewcommand{\arraystretch}{1.2} % augmente l'interligne dans les tableaux

% Gestion du texte barré
\usepackage[normalem]{ulem}

% =============================================================================
% 7. REDÉFINITIONS PERSONNALISÉES
% =============================================================================

% Commande pour la compatibilité Pandoc
\newcommand{\pandocbounded}[1]{#1}

% Redéfinition de texttt avec séparation automatique
\let\oldtexttt\texttt
\renewcommand{\texttt}[1]{\oldtexttt{\seqsplit{#1}}}

% Redéfinition de paragraph pour encadrer les titres
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{%
  \begin{framedparagraph}[frametitle={#1}]
  \end{framedparagraph}%
}

% =============================================================================
% 8. CONFIGURATION DE LA TABLE DES MATIÈRES
% =============================================================================

% Configuration de la profondeur de la table des matières
\settocdepth{subsubsection}

% Suppression du titre "Table des matières" et numérotation des pages
\makeatletter
\renewcommand{\tableofcontents}{%
  \clearpage
  \thispagestyle{empty}          % supprime numéro de la 1ère page du sommaire
  \begingroup
    \let\addcontentsline\@gobblethree
    \chapter*{\contentsname}
  \endgroup
  \@starttoc{toc}
  \thispagestyle{empty}          % supprime numéro si le sommaire déborde sur 2e page
}
\makeatother

% =============================================================================
% 9. VARIABLES DE CONTRÔLE DU DOCUMENT
% =============================================================================

% Variables booléennes pour contrôler l'affichage des éléments
\newif\ifCoverPage
\CoverPagefalse
\newif\ifHalfTitlePage
\HalfTitlePagefalse 
\newif\ifTitlePage
\TitlePagefalse
\newif\ifTableOfContents
\TableOfContentsfalse 
\newif\ifTableOfContentsEnd
\TableOfContentsEndfalse
\newif\ifPreventFootnoteBreak
\PreventFootnoteBreakfalse
\newif\ifSectionNewPage
\SectionNewPagefalse

% =============================================================================
% 10. CONFIGURATIONS SPÉCIALES
% =============================================================================

% Empêcher la coupure des notes de bas de page sur deux pages (optionnel)
\ifPreventFootnoteBreak
\interfootnotelinepenalty=10000
\fi

% Configuration de l'espacement des paragraphes
\sloppy
\needspace{3\baselineskip}

% =============================================================================
% 11. CORPS DU DOCUMENT
% =============================================================================

\begin{document}

% Page de couverture (optionnelle)
\ifCoverPage
\newpage
\fi

% Page de demi-titre (optionnelle)
\ifHalfTitlePage
\begin{titlingpage}
  \thispagestyle{plain}
  \centering
  {\Large\titrefont {{titre}}}\\
\end{titlingpage}
\fi

% Page de titre principale (optionnelle)
\ifTitlePage
    \begin{titlingpage}
        \thispagestyle{plain}
        \centering
        {\Large\titrefont {{titre}}}\\
        \includegraphics{images/{{imagecouv}}}
        {{auteur}}\\
    \end{titlingpage}
\fi

% Table des matières (optionnelle au début)
\ifTableOfContents
\tableofcontents
\fi

% Contenu principal du document
\input{content.tex}

% Table des matières (optionnelle à la fin)
\ifTableOfContentsEnd
\tableofcontents
\fi

\end{document}
